<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
        <title>{$title} - Chat | Aragorn.cz</title>
        <meta name="revisit-after" content="2 hours" />
        <meta name="robots" content="index, follow" />
        <meta name="author" content="Jakub Korál :: apophis, e-mail: apophis&#64;aragorn&#46;cz" />
        <meta name="keywords" content="online,on-line,fantasy,komunita,Dračí doupě,DrD,RPG,herna,články,galerie,ORP,Open Role Play" lang="cs" />
        <meta lang="cs" name="description" content="Aktuální úvodníky které obsahují novinky. Nejnovější články a naposledy schválené hry z herny. Náhodný obrázek z galerie." />
        <meta name="verify-v1" content="Ag52d+2UaYRLwlJy5DiR+SjkptPFk0nsSdKsIKNZpeI=" />
        <meta http-equiv="X-UA-Compatible" content="chrome=1" />
        <meta http-equiv="Content-Script-Type" content="text/javascript" />
        <meta http-equiv="Content-Style-Type" content="text/css" />
        <meta http-equiv="pragma" content="no-cache" />
        <meta name="ICBM" content="50.075342, 14.412575" />
        <meta http-equiv="Content-language" content="cs" />
        <base target="_blank" />
        <link rel="shortcut icon" type="image/x-icon" href="http://www.aragorn.cz/favicon.ico" />
        <link rel="stylesheet" media="print" type="text/css" href="{!$staticPath}/css/printing.css" />
        <link rel="stylesheet" media="screen,projection" type="text/css" href="{!$staticPath}/css/common.css" />
        <link rel="stylesheet" media="screen,projection" type="text/css" href="{!$staticPath}/css/chat.css" />
        <!--[if lt IE 7]><link rel="stylesheet" type="text/css" href="/assets/css/ie6.css" /><![endif]-->
        <script type="text/javascript" charset="utf-8" src="{!$staticPath}/js/mootools-core-1.3.1-full-nocompat-yc.js"></script>
        <script type="text/javascript" charset="utf-8" src="{!$staticPath}/js/mootools-more.js"></script>
        <script type="text/javascript" charset="utf-8" src="{!$staticPath}/js/socket.io.min.js"></script>
        <script type="text/javascript" charset="utf-8" src="{!$staticPath}/js/lazyload.js"></script>
        <script type="text/javascript" charset="utf-8" src="{!$staticPath}/js/powertools.js"></script>
        <script type="text/javascript" charset="utf-8" src="{!$staticPath}/js/floatingtips.js"></script>
        <script type="text/javascript" charset="utf-8" src="{!$staticPath}/js/aragorn-yc.js"></script>
        <script type="text/javascript" charset="utf-8" n:syntax="double">
            window.AUTHENTICATED = {{$isLogedIn = NEnvironment::getUser()->isLoggedIn()}};
            window.rid = {{$rid}};
            var Chat = null;
            var ChatClient = new Class({
                Implements:[Events, Options],
                options:{
                    tips:{
                        position:'left',
                        html:true,
                        distance:55,
                        content:function(e){ 
                            var info = JSON.decode(e.get('data-info')),
                                diff = parseInt((new Date().getTime() - info.time)/1000),
                                act = {m:parseInt(diff/60), s:diff%60, type:{idle:'Čte', 'writing':'Píše...', 'textready':'Má rozepsaný text', deleting:'Maže...', offline:'Nepřipojený'}},
                                html = '<img src="' + info.icon + '" style="max-height:50px; vertical-align: top;" />\n' +
                                       '<div style="display:inline-block; margin-left:3px;">\n' +
                                       '<b>' + info.name + '</b><br/>\n' + 
                                       '<i>'+ act.m + ' min. a ' + act.s + ' sec.</i><br/>\n'+
                                       '<span>' + act.type[info.state] + '</span><br/>\n' + 
                                       '<span>' + info.status + '</span>' +
                                       '</div>'; 
                            return html;
                        }
                    },
                    tipsSelector:'div.users',
                    userList:'user-list',
                    glass:'glass',
                    limit:50
                },
                initialize:function(t, options){
                    this.setOptions(options);
                    t.registerCmd('chat', this._handle.bind(this));
                    this.transport = t;
                    t.send('chat', {action:'enter', id:rid});
                    t.send('chat', {action:'userlist', id:rid});
                    this.tips = new FloatingTips(this.options.tipsSelector, this.options.tips);
                },
                transport:null,
                tips:null,
                connectedUsers:[],
                _handle:function(msg){
                    switch(msg.action){
                        case 'post':
                            var d = new Date();
                            d.setTime(msg.time);
                            new Element('div', {
                                id:msg.id,
                                styles:{
                                    color:msg.color
                                }
                            }).adopt(
                                new Element('a',{
                                    href:'#',
                                    text:'x',
                                    events:{
                                        click:function(e){
                                            if(e) e.stop();
                                            var mid = msg.id;
                                            console.log('Delete message ' + mid);
                                            this.transport.send('chat', {action:'delete', id:rid, messid:mid});
                                        }.bind(this)
                                    }
                                }),
                                new Element('span', {
                                    'class':'datetime',
                                    text:(d.getHours() < 10 ? '0' : '') + d.getHours() + ':' + (d.getMinutes() < 10 ? '0' : '') + d.getMinutes() + ':' + (d.getSeconds() < 10 ? '0' : '') + d.getSeconds() + ' '
                                }),
                                new Element('strong', {text:msg.from + ': '}),
                                new Element('span', {text:msg.message})
                            ).inject($(this.options.glass), 'top');
                            if(this.options.limit){
                                var c = $$('#' + this.options.glass + ' div'), s = parseInt(typeOf(this.options.limit) == 'number' ? this.options.limit : $(this.options.limit).get('value'));
                                for(var i = s - 1; i < c.length; i++){
                                    c[i].dispose()
                                }
                            }
                            break;
                        case 'queue':
                            for(var i = 0; i < msg.queue.length; i++){
                                AC.fireEvent('cmd_chat', msg.queue[i].data);
                            }
                            break;
                        case 'userlist':
                            $$('#user-list *').dispose(); 
                            this.connectedUsers = msg.list;
                            this.connectedUsers.each(function(usr){
                                var e = new Element('div', {
                                    'class':'users',
                                    'data-info':JSON.stringify(usr),
                                    text:usr.name
                                });
                                $(this.options.userList).grab(e);
                            }.bind(this));
                            this.tips.attach(this.options.tipsSelector);
                            break;
                        case 'delete':
                            $$('#' + msg.message).dispose();
                            break;
                     }
                }
            });
            window.addEvent('domready', function(){
                Chat = new ChatClient(AC, {limit:'glass-length'});
                $('msg').focus();
            });
        </script>
    </head>
    <body n:syntax="double">
        <div id="user-list" style="position: fixed; width: 140px; top:20px;right: 0; border-left: 1px dashed gray; bottom: 0; padding: 4px;"></div>
        <div id="glass" style="white-space: pre-wrap; overflow: auto; right: 150px; left: 0; bottom: 35px; top: 0;position: fixed;"></div>
        <div style="position:fixed; height: 30px; bottom: 0; left:0;right:0;">
            <form onsubmit="if(this.msg.value.length){ AC.send('chat',{action:'post', id:rid, message:this.msg.value}); this.msg.value='';}else{} return false;" style="display:inline;">
                Zpráva: <input type="text" name="msg" id="msg" /> <button type="submit">Odeslat</button>
            </form>
            <select name="glassLength" id="glass-length" title="Počet zobrazovaných zpráv" style="cursor: help;">
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="150">150</option>
                <option value="200">200</option>
                <option value="250">250</option>
                <option value="300">300</option>
            </select>
            <a href="{{link leave $rid}}" target="_self">Odejít</a>
        </div>
        <div id="constat" title="Connection status: offline">&nbsp;</div>
    </body>
</html>