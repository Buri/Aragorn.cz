/*
---
description: MooChoose is a replacement of the standard form Select UI Element. Style it however you want.

license:
  MIT-style

authors:
- Tomas Rainbolt

requires:
- core/1.2.4/Native: Event
- core/1.2.4/Class: Class
- core/1.2.4/Class: Class.Extras
- core/1.2.4/Element: Element
- core/1.2.4/Element: Element.Event
- core/1.2.4/Element: Element.Style
- core/1.2.4/Element: Element.Dimensions
- core/1.2.4/Utilities: Selectors
- core/1.2.4/Utilities: DomReady
- more/1.2.4/Element: Element.Measure

provides: [Element, Elements]

...
*/

var mooChoose=new Class({Implements:[Options,Events],options:{selectClass:"moochoose",selectId:null,baseClass:"mc_display",textPaddingLeft:5,openerWidth:20,openerFadeOverlap:10,optionHeight:20,maxShowOptions:10,optionsZIndex:10,optionsOffsetX:0,optionsOffsetY:3,optionsShadow:true,shadowBlur:4,shadowOffset:1,shadowColor:"#000",roundedOptionsCorners:true,optionsCornerRadius:5,},selects:{},mc_displays:[],searchByChar:false,charSearched:false,moochoosed:null,initialize:function(a){this.setOptions(a);this.selects=$$("select."+this.options.selectClass);this.selects.each(function(b,c){this.buildDisplay(b,c)}.bind(this))},buildDisplay:function(e,h){var m=e.measure(function(){return this.getCoordinates(e.getParent())});var d=new Element("a",{id:"mc_display_"+h,"class":this.options.baseClass,tabindex:e.getProperty("tabindex"),rel:"nofollow",styles:{width:(m.width-this.options.openerWidth),margin:e.getStyle("margin"),"margin-right":(parseInt(e.getStyle("margin-right"))+this.options.openerWidth)}}).inject(e,"before");var b=new Element("span",{"class":"mc_text",styles:{"margin-left":this.options.textPaddingLeft}}).inject(d);var n=new Element("span",{"class":"mc_opener",text:" ",styles:{"margin-left":m.width-this.options.openerWidth-this.options.openerFadeOverlap}}).inject(d,"top");var a=new Element("input",{type:"hidden",id:e.getProperty("id"),name:e.getProperty("name"),value:e.getProperty("value")}).inject(e,"before");var f=e.selectedIndex;var g=e.options[f].value;var l=e.options[f].text;var c=(e.getStyle("z-index").test(/[0-9]+/))?e.getStyle("z-index"):this.options.optionsZIndex;var k=new Element("span",{"class":"mc_options",styles:{position:"absolute","z-index":c}}).inject(b,"after");a.store("mc_display",d);d.store("mc_options",k);d.store("display_index",h);d.store("baseclass",this.options.baseClass);d.store("mc_hidden_el",e.getProperty("id"));this.mc_displays.push(d);var j=e.getChildren("option");if(j.length>this.options.maxShowOptions){k.setStyles({height:this.options.maxShowOptions*this.options.optionHeight,overflow:"auto"})}else{k.setStyles({height:j.length*this.options.optionHeight,overflow:"hidden"})}if(this.options.optionsShadow){k.setStyles({"-moz-box-shadow":this.options.shadowOffset+"px "+this.options.shadowOffset+"px "+this.options.shadowBlur+"px "+this.options.shadowColor,"-webkit-box-shadow":this.options.shadowOffset+"px "+this.options.shadowOffset+"px "+this.options.shadowBlur+"px "+this.options.shadowColor,"box-shadow":this.options.shadowOffset+"px "+this.options.shadowOffset+"px "+this.options.shadowBlur+"px "+this.options.shadowColor})}j.each(function(s,q){var o=e.options[q].value;var p=e.options[q].text;var r=new Element("span",{"class":"mc_option",text:p,title:e.options[q].text,events:{mousedown:function(v){if(v){v.stopPropagation()}if(r.hasClass("active")){return false}else{a.setProperty("value",o);a.store("selected_index",q);b.setProperty("text",p);d.setProperty("title",p);k.getChildren("span.mc_option").each(function(x){(x!=r)?x.removeClass("active"):x.addClass("active")});if(e.getProperty("onchange")){var t=e.getProperty("onchange");var u=/this/;var w=(u.test(t))?t.replace("this","$('"+e.getProperty("id")+"')"):t;var i=new Function([w]);i()}this.selected()}this.hideOptions(d,k)}.bind(this)}}).inject(k,"bottom");if(a.getProperty("value")!=undefined){if(q==f){r.addClass("active");a.store("selected_index",q)}}else{if(r.getProperty("value")==a.getProperty("value")){r.addClass("active");a.store("selected_index",q)}}}.bind(this));d.addEvents({mousedown:function(){this.moochoosed=d;this.toggleOptions(d,k,a,j)}.bind(this),focus:function(){if(this.moochoosed!=d){this.moochoosed=d;this.showOptions(d,k,a,j)}if(e.getProperty("onfocus")){var q=e.getProperty("onfocus");var p=/this/;var i=(p.test(q))?q.replace("this","$('"+e.getProperty("id")+"')"):q;var o=new Function([i]);o()}this.focused()}.bind(this),blur:function(){this.hideOptions(d,k);if(e.getProperty("onblur")){var p=e.getProperty("onblur");var q=/this/;var o=(q.test(p))?p.replace("this","$('"+e.getProperty("id")+"')"):p;var i=new Function([o]);i()}this.blurred()}.bind(this),keypress:function(u){if(u.key=="up"||u.key=="down"){u.preventDefault()}var i=u.key;var s=/([a-z0-9])/;var v=s.test(i);var x=k.getChildren("span");var t=x.length;var w=a.retrieve("selected_index");var p=(a.retrieve("highlighted")!=undefined)?a.retrieve("highlighted"):w;var r=(p==t-1)?0:(p+1);var o=(p>0)?(p-1):(t-1);if(i=="up"){if(k.getStyle("display")=="none"){this.showOptions(d,k,a,j)}a.store("highlighted",o);k.scrollTo(0,(o*this.options.optionHeight));if(!x[o].hasClass("active")){x[o].addClass("hover")}x[p].removeClass("hover")}else{if(i=="down"){if(k.getStyle("display")=="none"){this.showOptions(d,k,a,j)}a.store("highlighted",r);k.scrollTo(0,(r*this.options.optionHeight));if(!x[r].hasClass("active")){x[r].addClass("hover")}x[p].removeClass("hover")}else{if(i=="enter"){x[p].fireEvent("mousedown")}else{if(v){var q=[];if(this.selectedChar!=i){this.selectedByChar=false}x.each(function(z,y){var A=z.get("text").toLowerCase();if(i==A.charAt(0)){q.push(y)}});if(q.length){if(k.getStyle("display")=="none"){this.showOptions(d,k,a,j)}if(this.selectedByChar===false){a.store("highlighted",q[0]);k.scrollTo(0,(q[0]*this.options.optionHeight));if(!x[q[0]].hasClass("active")){x[q[0]].addClass("hover")}x[p].removeClass("hover");this.selectedByChar=0;this.selectedChar=i}else{if(q.length==1){return}else{var r=(this.selectedByChar==q.length-1)?0:(this.selectedByChar+1);a.store("highlighted",q[r]);k.scrollTo(0,(q[r]*this.options.optionHeight));if(!x[q[r]].hasClass("active")){x[q[r]].addClass("hover")}x[p].removeClass("hover");this.selectedByChar=r;this.selectedChar=i}}}}}}}}.bind(this)});n.addEvents({click:function(i){d.focus()}.bind(this)});k.addEvents({mousedown:function(i){i.stopPropagation()},mousewheel:function(i){i.stopPropagation()}});window.addEvents({mousewheel:function(){this.hideOptions(d,k)}.bind(this),resize:function(){this.hideOptions(d,k)}.bind(this)});e.destroy();a.setProperty("value",g);a.store("selected_index",f);b.setProperty("text",l);d.setProperty("title",l)},addSelect:function(a){if(a.getProperty("type")=="hidden"){return}this.selects.push(a);this.buildDisplay(a,this.selects.length)},toggleOptions:function(c,b,d,a){(c.hasClass("active"))?this.hideOptions(c,b):this.showOptions(c,b,d,a)},showOptions:function(e,g,a,h){$$("span.mc_options").each(function(m){m.setStyle("display","none")});this.mc_displays.each(function(m){(m!=this.moochoosed)?m.removeClass("active"):m.addClass("active")}.bind(this));var f=g.measure(function(){return this.getSize()});if(g.retrieve("optionsWidth")){var c=g.retrieve("optionsWidth")}else{var c=f.x+13;g.store("optionsWidth",c)}var l=e.getCoordinates();var k=window.getSize();var j=new Element("div",{styles:{position:"absolute",width:1,height:1,top:0,left:0}}).inject(e,"top");var i=j.getCoordinates();if((k.y-l.top-l.height-f.y-this.options.optionsOffsetY+window.getScroll().y)>=0){var b=l.top+l.height+this.options.optionsOffsetY-i.top}else{var b=l.top-f.y-this.options.optionsOffsetY-i.top}if((k.x-l.left)>=(c+this.options.optionsOffsetX)){var d=l.left+this.options.optionsOffsetX-i.left}else{var d=l.left+l.width-f.x-this.options.optionsOffsetX-(i.left)}j.dispose();g.setStyles({display:"inline-block",top:b,left:d});if(!Browser.Engine.trident){g.setStyle("width",c)}if(this.options.roundedOptionsCorners){g.setStyles({"-moz-border-radius":this.options.optionsCornerRadius+"px","-webkit-border-radius":this.options.optionsCornerRadius+"px","border-radius":this.options.optionsCornerRadius+"px"})}if(h.length>this.options.maxShowOptions){g.scrollTo(0,(a.retrieve("selected_index")*this.options.optionHeight))}},hideOptions:function(b,a){b.removeClass("active");a.setStyle("display","none")},changeClass:function(a,c){var b=a.retrieve("mc_display");b.removeClass(b.retrieve("baseclass"));b.addClass(c);b.store("baseclass",c)},focused:function(){this.fireEvent("focused")},blurred:function(){this.fireEvent("blurred")},selected:function(){this.fireEvent("selected")}});