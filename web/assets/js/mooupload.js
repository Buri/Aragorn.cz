var progressSupport=("onprogress" in new Browser.Request);Request.implement({sendBlob:function(b){this.options.isSuccess=this.options.isSuccess||this.isSuccess;this.running=true;var c=String(this.options.url),e=this.options.method.toLowerCase();if(!c){c=document.location.pathname}var a=c.lastIndexOf("/");if(a>-1&&(a=c.indexOf("#"))>-1){c=c.substr(0,a)}if(this.options.noCache){c+=(c.contains("?")?"&":"?")+String.uniqueID()}var d=this.xhr;if(progressSupport){d.onloadstart=this.loadstart.bind(this);d.onprogress=this.progress.bind(this)}d.open(e.toUpperCase(),c,this.options.async,this.options.user,this.options.password);if(this.options.user&&"withCredentials" in d){d.withCredentials=true}d.onreadystatechange=this.onStateChange.bind(this);Object.each(this.headers,function(g,f){try{d.setRequestHeader(f,g)}catch(h){this.fireEvent("exception",[f,g])}},this);this.fireEvent("request");d.send(b);if(!this.options.async){this.onStateChange()}if(this.options.timeout){this.timer=this.timeout.delay(this.options.timeout,this)}return this}});var MooUpload=new Class({Implements:[Options,Events],options:{action:"upload.php",draggable:true,accept:"*/*",method:"auto",multiple:true,autostart:false,listview:true,blocksize:101400,maxuploadspertime:2,minfilesize:1,maxfilesize:0,maxfiles:0,verbose:false,flash:{movie:"Moo.Uploader.swf"},texts:{error:"Error",file:"File",filesize:"Filesize",filetype:"Filetype",nohtml5:"Not support HTML5 file upload!",noflash:"Please install Flash 8.5 or highter version (Have you disabled FlashBlock or AdBlock?)",maxselect:"You can only select a maximum of {maxfiles} files",sel:"Sel.",selectfile:"Add files",status:"Status",startupload:"Start upload",uploaded:"Uploaded"},onAddFiles:function(){},onBeforeUpload:function(){},onFileDelete:function(a){},onFileUpload:function(a,b){},onFileUploadError:function(a,b){},onFinishUpload:function(){},onLoad:function(){},onSelect:function(){},onSelectError:function(c,a,b){}},filelist:new Array(),lastinput:undefined,uploadspertime:0,uploading:true,flashobj:null,flashloaded:false,initialize:function(a,b){this.container=document.id(a);this.setOptions(b);Object.append(Element.NativeEvents,{dragenter:2,dragexit:2,dragover:2,drop:2});this[this.options.method](this.container)},baseHtml:function(g){var c=g.get("id");var i=new Element("div",{"class":"mooupload_btncontainer"}).inject(g);var d=new Element("button",{id:c+"_btnAddfile",html:this.options.texts.selectfile,type:"button","class":"addfile"}).inject(i);this.newInput(g);if(!this.options.autostart){var h=new Element("button",{id:c+"_btnbStart",html:this.options.texts.startupload,type:"button","class":"start"}).inject(i);h.addEvent("click",function(){this.upload(g)}.bind(this))}var b=new Element("div",{id:c+"_progresscont","class":"progresscont"}).inject(i);new Element("div",{id:c+"_progressbar",html:"0%","class":"mooupload_on mooupload_progressbar"}).inject(b);if(this.options.listview){var f=new Element("div.mooupload_listview",{id:c+"_listView"}).inject(g);var a=new Element("ul").inject(f);var e=new Element("li.header").inject(a).adopt(new Element("div.optionsel",{html:this.options.texts.sel}),new Element("div.filename",{html:this.options.texts.file}),new Element("div.filesize",{html:this.options.texts.filesize}),new Element("div.result",{html:this.options.texts.status}))}this.fireEvent("onLoad")},htmlAddFile:function(b){var a=b.get("id");document.id(a+"_btnAddfile").addEvent("click",function(c){c.stop();if(this.options.maxfiles&&this.countStats().checked>=this.options.maxfiles){this.fireEvent("onSelectError",["maxfiles",this.filelist[this.filelist.length-1].name,this.filelist[this.filelist.length-1].size]);if(this.options.texts.maxselect.length>0){alert(this.options.texts.maxselect.substitute(this.options));return false}}this.lastinput.click();this.progressIni(document.id(a+"_progresscont"))}.bind(this))},newInput:function(d){var a=document.id(d).get("id");var b=this.countContainers(d);var c=d;if(b>0){document.id(a+"_tbxFile"+(b-1)).setStyle("display","none")}if(this.options.method=="html4"){c=new Element("form",{id:a+"_frmFile"+b,name:a+"_frmFile"+b,enctype:"multipart/form-data",encoding:"multipart/form-data",method:"post",action:this.options.action,target:a+"_frmFile"}).inject(d);if(this.options.maxfilesize>0){new Element("input",{name:"MAX_FILE_SIZE",type:"hidden",value:this.options.maxfilesize}).inject(c)}}this.lastinput=new Element("input",{id:a+"_tbxFile"+b,name:a+"_tbxFile"+b,type:"file",size:1,styles:{position:"absolute",top:0,left:0,border:0},multiple:this.options.multiple,accept:this.options.accept}).inject(c);if(this.options.method!="flash"&&(Browser.firefox2||Browser.firefox3||Browser.opera||Browser.ie)){this.moveInput(d)}else{this.lastinput.setStyle("visibility","hidden")}this.lastinput.addEvent("change",function(f){f.stop();if(this.options.method=="html4"){this.addFiles([{name:this.getInputFileName(this.lastinput,d),type:null,size:null}],d)}else{this.addFiles(this.lastinput.files,d)}}.bind(this));if(this.options.maxfiles&&this.countStats().checked>=this.options.maxfiles){this.lastinput.setStyle("display","none")}},moveInput:function(c){var a=c.getElementById(c.get("id")+"_btnAddfile");var b=a.getCoordinates(a.getOffsetParent());this.lastinput.setStyles({top:b.top,left:b.left-1,width:b.width+2,height:b.height,opacity:0.0001,"-moz-opacity":0})},upload:function(b){this.uploading=false;this.fireEvent("onBeforeUpload");var a=document.id(b).get("id");if(this.options.listview){document.id(a+"_listView").getElements("li.item").addClass("mooupload_readonly");document.id(a+"_listView").getElements("a").setStyle("visibility","hidden")}this.progressStep(document.id(a+"_progresscont"));this[this.options.method+"Upload"](b)},progressStep:function(a){if(a.getStyle("display")=="none"){a.setStyle("display","block")}var b=a.getChildren("div");var c=this.countStats();c.uploaded++;c.checked++;var d=(c.uploaded/c.checked)*100;b.set("tween",{duration:"short"});b.tween("width",d+"%");b.set("html",d.ceil()+"%");if(d>=100){this.uploading=false;b.removeClass("mooupload_on");b.addClass("mooupload_off");this.fireEvent("onFinishUpload")}},progressIni:function(a){var b=a.getChildren("div");b.removeClass("mooupload_off");b.addClass("mooupload_on");a.setStyle("display","none");b.setStyle("width",0);b.set("html","0%")},addFiles:function(a,j){var d=j.get("id");var e=false;if(this.options.listview&&j!==undefined){var h=document.id(j.get("id")+"_listView").getElement("ul")}for(var g=0,l;l=a[g];g++){var c=l.name||l.fileName;var b=l.size||l.fileSize;var k=true;if(this.options.maxfiles&&this.countStats().checked>=this.options.maxfiles){this.fireEvent("onSelectError",["maxfiles",c,b]);e=true;k=false}if(b!=undefined){if(b<this.options.minfilesize){this.fireEvent("onSelectError",["minfilesize",c,b]);k=false}if(this.options.maxfilesize>0&&b>this.options.maxfilesize){this.fireEvent("onSelectError",["maxfilesize",c,b]);k=false}}this.filelist[this.filelist.length]={id:String.uniqueID(),checked:k,name:c,type:l.type||l.extension,size:b,uploaded:false,uploading:false,error:false};if(this.options.listview&&j!==undefined&&k){this.addFileList(j,h,this.filelist[this.filelist.length-1])}}if(e&&this.options.texts.maxselect.length>0){alert(this.options.texts.maxselect.substitute(this.options))}this.fireEvent("onAddFiles");this.newInput(j);if(this.options.autostart){this.upload(j)}},addFileList:function(a,h,e){var c=a.get("id");var d=new Element("li",{"class":"item"}).inject(h);var g=new Element("div",{"class":"optionsel"}).inject(d);var f=new Element("a",{id:c+"_delete"+this.filelist.length,"class":"delete"}).inject(g);var b=this.filelist.length-1;f.addEvent("click",function(j){j.stop();this.filelist[b].checked=false;f.removeEvents("click");f.getParent("li").destroy();this[this.options.method+"Delete"](b);var i=this.countContainers(a);if(i>0){document.id(c+"_tbxFile"+(i-1)).setStyles({visibility:"hidden",display:"block"})}this.fireEvent("onFileDelete",[b])}.bind(this));new Element("div",{"class":"filename",html:e.name}).inject(d);new Element("div",{"class":"filesize",html:(e.size||"n/a")+" bytes"}).inject(d);new Element("div",{id:c+"_file_"+this.filelist.length,"class":"result"}).inject(d);d.highlight("#FFF","#E3E3E3")},getContainers:function(a){return a.getElements("input[type=file]")},getForms:function(a){return a.getElements("form")},countContainers:function(b){var a=this.getContainers(b);return a.length},countStats:function(){var b={checked:0,uploaded:0,uploading:0,error:0};for(var a=0,c;c=this.filelist[a];a++){if(c.checked){b.checked++;b.uploaded+=c.uploaded?1:0;b.uploading+=c.uploading?1:0;b.error+=c.error?1:0}}return b},auto:function(a){if(window.File&&window.FileList&&window.FileReader&&window.Blob){this.options.method="html5";if(Browser.opera&&Browser.version<=11.11){this.options.method="auto"}}if(this.options.method=="auto"){this.options.method=Browser.Plugins.Flash&&Browser.Plugins.Flash.version>=9?"flash":"html4"}this[this.options.method](a)},flash:function(g){var a=g.get("id");if(!Browser.Plugins.Flash||Browser.Plugins.Flash.version<9){g.set("html",this.options.texts.noflash);return false}this.baseHtml(g);var e=this.flashFilter(this.options.accept);var c=g.getElementById(a+"_btnAddfile");var d=c.getPosition(c.getOffsetParent());var b=c.getSize();var f=new Element("div",{id:a+"_flash",styles:{position:"absolute",top:d.y,left:d.x}}).inject(g);if(Browser.ie){this.options.flash.movie+=(this.options.flash.movie.contains("?")?"&":"?")+"mooupload_movie="+Date.now()}this.flashobj=new Swiff(this.options.flash.movie,{container:f.get("id"),width:b.x,height:b.y,params:{wMode:"transparent",bgcolor:"#000000"},callBacks:{load:function(){Swiff.remote(this.flashobj.toElement(),"xInitialize",{multiple:this.options.multiple,url:this.options.action,method:"post",queued:this.options.maxuploadspertime,fileSizeMin:this.options.fileminsize,fileSizeMax:this.options.filemaxsize?this.options.filemaxsize:null,maxFiles:this.options.maxfiles,typeFilter:e,mergeData:true,data:this.cookieData(),verbose:this.options.verbose});this.flashloaded=true}.bind(this),select:function(h){this.addFiles(h[0],g);this.progressIni(document.id(a+"_progresscont"))}.bind(this),complete:function(h){this.uploading=false}.bind(this),fileProgress:function(h){if(this.options.listview){var i=document.id(a+"_file_"+h[0].id);i.set("html",h[0].progress.percentLoaded+"%")}}.bind(this),fileComplete:function(h){this.filelist[h[0].id-1].uploaded=true;if(this.options.listview){var i=document.id(a+"_file_"+h[0].id);if(h[0].response.error>0){i.addClass("mooupload_error");i.set("html",this.options.texts.error)}else{i.addClass("mooupload_noerror");i.set("html",this.options.texts.uploaded)}}this.progressStep(document.id(a+"_progresscont"));this.fireEvent("onFileUpload",[h[0].id,JSON.decode(h[0].response.text)])}.bind(this),maxFilesError:function(){this.fireEvent("onSelectError",["maxfiles",this.filelist[this.filelist.length-1].name,this.filelist[this.filelist.length-1].size]);if(this.options.texts.maxselect.length>0){alert(this.options.texts.maxselect.substitute(this.options))}}.bind(this)}})},flashUpload:function(c){if(!this.uploading){this.uploading=true;for(var a=0,b;b=this.filelist[a];a++){if(!b.uploading){Swiff.remote(this.flashobj.toElement(),"xFileStart",a+1);this.filelist[a].uploading=true}}}},flashDelete:function(a){this.filelist[a].checked=false;Swiff.remote(this.flashobj.toElement(),"xFileRemove",a+1)},flashFilter:function(c){var a={},d={};var b={image:"*.jpg; *.jpeg; *.gif; *.png; *.bmp;",video:"*.avi; *.mpg; *.mpeg; *.flv; *.ogv; *.webm; *.mov; *.wm;",text:"*.txt; *.rtf; *.doc; *.docx; *.odt; *.sxw;","*":"*.*;"};c.split(",").each(function(e){e=e.split("/").invoke("trim");a[e[0]]=(a[e[0]]?a[e[0]]+" ":"")+"*."+e[1]+";"});Object.each(a,function(g,e){var f=e=="*"?"All Files":e.capitalize();if(g=="*.*;"){g=b[e]}d[f+" ("+g+")"]=g});return d},cookieData:function(){var a={};document.cookie.split(/;\s*/).each(function(b){b=b.split("=");if(b.length==2){a[decodeURIComponent(b[0])]=decodeURIComponent(b[1])}});return a},html5:function(a){if(!window.File||!window.FileList||!window.FileReader||!window.Blob){a.set("html",this.options.texts.nohtml5);return false}this.baseHtml(a);this.htmlAddFile(a)},html5Upload:function(b){var a=0;this.getContainers(b).each(function(d){var e=d.files;for(var c=0,g;g=e[c];c++){if(this.uploadspertime<=this.options.maxuploadspertime){if(this.filelist[a].checked&&!this.filelist[a].uploading){this.uploading=true;this.filelist[a].uploading=true;this.uploadspertime++;this.html5send(b,this.filelist[a].id,g,0,a,false)}}a++}}.bind(this))},html5send:function(g,h,c,a,b,d){var f=this.options.blocksize,e=this.options.action,j;var i=a+f;if(i>c.size){f=i-c.size}if(c.mozSlice){j=c.mozSlice(a,i)}else{if(c.webkitSlice){j=c.webkitSlice(a,i)}else{j=c.slice(a,i)}}var k=new Request({url:e,urlEncoded:false,noCache:true,headers:{"Cache-Control":"no-cache","X-Requested-With":"XMLHttpRequest","X-File-Name":c.name,"X-File-Size":c.size,"X-File-Id":h,"X-File-Resume":d},onSuccess:function(l){l=JSON.decode(l);if(this.options.listview){var n=document.id(g.get("id")+"_file_"+(b+1))}if(l.error==0){if(i<c.size){if(this.options.listview){var m=(i/c.size)*100;n.set("html",m.ceil()+"%")}this.html5send(g,h,c,a+l.size.toInt(),b,true)}else{if(this.options.listview){n.addClass("mooupload_noerror");n.set("html",this.options.texts.uploaded)}this.uploadspertime--;this.filelist[b].uploaded=true;this.progressStep(document.id(g.get("id")+"_progresscont"));this.fireEvent("onFileUpload",[b,l]);if(this.uploadspertime<=this.options.maxuploadspertime){this.html5Upload(g)}}}else{if(this.options.listview){n.addClass("mooupload_error");n.set("html",this.options.texts.error)}this.uploadspertime--;this.filelist[b].uploaded=true;this.progressStep(document.id(g.get("id")+"_progresscont"));this.fireEvent("onFileUpload",[b,l]);this.fireEvent("onFileUploadError",[b,l]);if(this.uploadspertime<=this.options.maxuploadspertime){this.html5Upload(g)}}}.bind(this)});k.sendBlob(j)},html5Delete:function(a){},html4:function(c){var a=c.get("id");this.options.multiple=false;var b=new IFrame({id:a+"_frmFile",name:a+"_frmFile",styles:{display:"none"}});b.addEvent("load",function(){var d=b.contentWindow.document.body.innerHTML;if(d!=""){this.uploading=false;this.html4Upload(c);d=JSON.decode(d);if(this.options.listview){var e=document.id(a+"_file_"+(d.key+1))}if(d.error>0){if(this.options.listview){e.addClass("mooupload_error");e.set("html",this.options.texts.error)}this.fireEvent("onFileUploadError",[d.key,d])}else{this.filelist[d.key].uploaded=true;this.filelist[d.key].size=d.size;if(this.options.listview){e.addClass("mooupload_noerror");e.set("html",this.options.texts.uploaded);e.getPrevious(".filesize").set("html",d.size+" bytes")}}this.progressStep(document.id(c.get("id")+"_progresscont"));this.fireEvent("onFileUpload",[d.key,d])}}.bind(this)).inject(c);this.baseHtml(c);this.htmlAddFile(c)},html4Upload:function(b){var a=0;if(!this.uploading){this.getForms(b).each(function(d){var c=this.filelist[a];if(c!=undefined&&!this.uploading){if(c.checked&&!c.uploading){c.uploading=true;this.uploading=true;var e=d.submit()}}a++}.bind(this))}},html4Delete:function(a){},getInputFileName:function(a){var b=a.get("value").split(/(\\|\/)/g);return b[b.length-1]}});