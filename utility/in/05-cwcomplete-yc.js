var CwAutocompleter=new Class({Implements:[Options,Events],options:{ajaxMethod:"get",ajaxParam:"search",inputMinLength:3,pause:0,targetfieldForKey:"",targetfieldForValue:"",suggestionBoxOuterClass:"cwCompleteOuter",suggestionBoxListClass:"cwCompleteChoices",suggestionBoxLoadingClass:"cwCompleteLoading",suggestionBoxHoverClass:"cwCompleteChoicesHover",clearChoicesOnBlur:true,clearChoicesOnEsc:true,clearChoicesOnChoose:true,setValuesOnChoose:true,suggestionContainer:{},choiceContainer:"ul",choiceElement:"li",onChoose:function(){},filter:function(a){return a}},initialize:function(e,d,c){this.setOptions(c);if(!$(e)){return}this.prevlength=0;this.textfield=$(e);this.url=d;this.clickeddoc=false;var f=this.textfield.getStyle("width");var a=this.textfield.getPosition().x;var b=this.textfield.getPosition().y+this.textfield.getSize().y;if(this.options.suggestionContainer&&$(this.options.suggestionContainer)){this.container=$(this.options.suggestionContainer);this.container.addClass(this.options.suggestionBoxOuterClass)}else{this.container=new Element("div",{"class":this.options.suggestionBoxOuterClass,styles:{width:f,left:a,top:b,height:0}}).inject($(document.body))}this.choices=new Element(this.options.choiceContainer,{"class":this.options.suggestionBoxListClass}).inject($(this.container),"inside");this.clearChoices();this.textfield.setProperty("autocomplete","off");this.textfield.addEvents({keydown:this.keypressed.bind(this),keyup:this.keypressed.bind(this)});if(this.options.clearChoicesOnBlur){if(!Browser.ie){this.textfield.addEvents({blur:this.clearChoices.bind(this)})}else{document.addEvent("click",this.docclick.bind(this));this.textfield.addEvents({blur:this.blurLater.bind(this)})}}if(!Browser.ie){this.choices.addEvents({mousedown:function(g){g.preventDefault()}})}if(this.url){this.ajax=new Request({url:this.url,method:this.options.ajaxMethod});this.ajax.addEvent("onComplete",this.ajaxComplete.bind(this))}},getValues:function(a){var c=a;if(this.options.doRetrieveValues!=null){this.setValues(this.options.doRetrieveValues.apply(a))}else{if(this.ajax){if(this.options.pause===0){this.choices.hide();this.container.addClass(this.options.suggestionBoxLoadingClass);this.container.show();this.ajax.send(this.options.ajaxParam+"="+c)}else{var b=this;window.setTimeout(function(){if(c==b.textfield.get("value")){b.choices.hide();b.container.addClass(b.options.suggestionBoxLoadingClass);b.container.show();b.ajax.send(b.options.ajaxParam+"="+c)}else{b.ajax.cancel()}},b.options.pause)}}}},ajaxComplete:function(a){if(!a){return}var b=JSON.decode(a,true);if(b===false||!b.length){this.clearChoices()}else{this.setValues(b)}},setValues:function(a){this.values=a;this.clearChoices();this.values.each(function(b,c){if(b){this.lielems[c]=new Element(this.options.choiceElement,{html:b[1]});this.lielems[c].addEvent("click",this.enterValue.bind(this,{id:b[0],value:b[1]}));if(Browser.ie){this.lielems[c].addEvent("mousedown",this.enterValue.bind(this,{id:b[0],value:b[1]}))}this.lielems[c].inject(this.choices,"inside")}}.bind(this));this.container.show();this.container.removeClass(this.options.suggestionBoxLoadingClass);this.choices.show();this.lielems[this.selected].addClass(this.options.suggestionBoxHoverClass)},clearChoices:function(a){this.lielems=[];this.selected=0;this.choices.set("html","");this.container.hide()},enterValue:function(a){if(this.options.setValuesOnChoose){if(this.options.targetfieldForKey&&$(this.options.targetfieldForKey)){$(this.options.targetfieldForKey).value=a.id}if(this.options.targetfieldForValue&&$(this.options.targetfieldForValue)){$(this.options.targetfieldForValue).value=a.value}else{this.textfield.value=a.value}}this.fireEvent("onChoose",{key:a.id,value:a.value});if(this.options.clearChoicesOnChoose){this.clearChoices()}},moveUp:function(a,b){if(this.lielems[this.selected]&&this.lielems[this.selected-1]){this.lielems[this.selected].removeClass(this.options.suggestionBoxHoverClass);this.selected-=1;this.lielems[this.selected].addClass(this.options.suggestionBoxHoverClass)}},moveDown:function(a,b){if(this.lielems[this.selected]&&this.lielems[this.selected+1]){this.lielems[this.selected].removeClass(this.options.suggestionBoxHoverClass);this.selected+=1;this.lielems[this.selected].addClass(this.options.suggestionBoxHoverClass)}},keypressed:function(b){var c=b;if(c.target.id===this.textfield.id){if(c.type=="keyup"){switch(c.key){case"enter":if(this.lielems[this.selected]){this.lielems[this.selected].fireEvent("click")}b.preventDefault();break;case"down":this.moveDown();b.preventDefault();break;case"up":this.moveUp();b.preventDefault();break;case"esc":if(this.options.clearChoicesOnEsc){this.clearChoices()}break;default:var d=c.target.value;if(d.length!=this.prevlength){if(d.length>=this.options.inputMinLength){this.prevlength=d.length;var a=this.options.filter(d,c);if(a){this.getValues(a)}}else{this.clearChoices()}b.preventDefault()}}}else{if(c.key=="enter"||c.key=="esc"){}else{if((c.key=="down"||c.key=="up")&&$$(".cwCompleteOuter")[0].getStyle("display")=="block"){b.preventDefault()}else{this.prevlength=c.target.value.length}}}}},docclick:function(a){if(this.textfield.id!==a.target.id){this.clickeddoc=true}},blurLater:function(b){var a=this;var c=function(){if(a.clickeddoc){a.clickeddoc=false;a.clearChoices(b)}else{a.textfield.focus()}};setTimeout(c,200)}});